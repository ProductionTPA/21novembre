<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calendrier Production ‚Äî TPA</title>
  <style>
    :root{
      --stroke:rgba(255,255,255,.08);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --muted2:rgba(255,255,255,.55);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
      --cellH: 104px;
      --cellHYear: 74px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 600px at 15% 0%, rgba(106,167,255,.22), transparent 60%),
                  radial-gradient(900px 500px at 85% 10%, rgba(255,0,145,.10), transparent 55%),
                  linear-gradient(180deg, #070b14, #0b1220 40%, #070b14);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
    }
    header{
      background: rgba(11,18,32,.72);
      border-bottom: 1px solid var(--stroke);
      backdrop-filter: blur(10px);
    }
    .wrap{max-width:1800px; margin:0 auto; padding:18px 18px 22px;}
    .top{display:flex; gap:14px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;}
    .brand{display:flex; gap:12px; align-items:center;}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, rgba(106,167,255,.95), rgba(106,167,255,.35));
      box-shadow: 0 10px 25px rgba(106,167,255,.18);
      border:1px solid rgba(255,255,255,.18);
      display:grid; place-items:center;
      font-weight:800; letter-spacing:.8px;
    }
    .title h1{margin:0; font-size:18px; letter-spacing:.3px}
    .title p{margin:4px 0 0; color:var(--muted); font-size:13px}

    .panel{
      display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;
      background: rgba(17,27,46,.65);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      padding:10px;
      box-shadow: var(--shadow);
    }
    .field{display:flex; flex-direction:column; gap:6px; min-width: 150px;}
    label{font-size:11px; color:var(--muted2)}
    input[type="number"], input[type="text"], textarea, select{
      appearance:none;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--stroke);
      color: var(--text);
      border-radius: 12px;
      padding:10px 12px;
      outline:none;
      font-size:14px;
    }
    input:focus, textarea:focus, select:focus{
      border-color: rgba(106,167,255,.65);
      box-shadow: 0 0 0 3px rgba(106,167,255,.15)
    }

    .btn{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:700;
      display:inline-flex; gap:8px; align-items:center;
      user-select:none;
    }
    .btn:hover{background: rgba(255,255,255,.10)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(106,167,255,.95), rgba(106,167,255,.45));
      border-color: rgba(106,167,255,.35);
      color:#06101f;
    }
    .btn.primary:hover{filter:brightness(1.05)}
    .btn.danger{border-color: rgba(255,90,90,.35); background: rgba(255,90,90,.10);}
    .btn.ghost{background: rgba(255,255,255,.04);}
    .btn.small{padding:8px 10px; font-size:11.2px; border-radius: 11px; font-weight:800;}
    .btn.toggle.active{
      outline: 2px solid rgba(106,167,255,.35);
      background: rgba(106,167,255,.16);
      border-color: rgba(106,167,255,.35);
    }
    .btn.disabled, .btn:disabled{
      opacity:.45;
      cursor:not-allowed;
    }

    .bar{
      margin-top:12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .monthButtons{display:flex; flex-wrap:wrap; gap:8px; align-items:center;}
    .monthButtons .btn{min-width:92px; justify-content:center;}
    .rightActions{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}

    .status{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      font-size:11.2px;
      color: var(--muted);
      white-space:nowrap;
    }
    .status .dot{width:10px;height:10px;border-radius:999px;border:1px solid rgba(255,255,255,.25); box-shadow: 0 0 10px rgba(255,255,255,.12)}
    .status.unlock{color: rgba(255,255,255,.9)}
    .status.unlock .dot{background:#00F07A}
    .status.lock .dot{background:#FFB300}

    .legend{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      font-size:11.2px; color: var(--muted);
      cursor:pointer;
      user-select:none;
    }
    .dot{width:10px;height:10px;border-radius:999px;border:1px solid rgba(255,255,255,.25); box-shadow: 0 0 10px rgba(255,255,255,.12)}
    .pill.active{outline: 2px solid rgba(106,167,255,.35); color: var(--text)}

    main{padding: 10px 10px 18px;}
    .months{
      max-width:1800px; margin:0 auto;
      display:grid;
      grid-template-columns: repeat(2, minmax(660px, 1fr));
      gap:16px;
      padding-bottom: 30px;
    }
    .months.year{grid-template-columns: repeat(2, minmax(660px, 1fr));}

    .month{
      background: rgba(17,27,46,.55);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .month.focus{
      grid-column: 1 / -1;
      position: relative;
      z-index: 20;
      outline: 2px solid rgba(106,167,255,.35);
      box-shadow: 0 25px 70px rgba(0,0,0,.55);
    }

    .monthHead{
      padding:14px 14px 10px;
      display:flex; align-items:flex-end; justify-content:space-between; gap:10px; flex-wrap:wrap;
      border-bottom: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      cursor:pointer;
    }
    .monthHead h2{margin:0; font-size:16px}
    .monthHead small{color:var(--muted2)}
    .monthHead .hintClick{font-size:11px; color:rgba(255,255,255,.55)}

    .grid{display:grid; grid-template-columns: repeat(7, 1fr); border-top: 1px solid var(--stroke);}
    .dow{
      padding:10px 8px;
      font-size:11px;
      color: var(--muted2);
      text-transform:uppercase;
      letter-spacing:.8px;
      border-right: 1px solid var(--stroke);
      background: rgba(15,23,41,.55);
    }
    .dow:nth-child(7){border-right:none}

    .cell{
      min-height: var(--cellH);
      padding:10px 10px 8px;
      border-right: 1px solid var(--stroke);
      border-bottom: 1px solid var(--stroke);
      background: rgba(15,23,41,.42);
      position:relative;
      cursor:pointer;
      display:flex; flex-direction:column; gap:6px;
    }
    .year .cell{min-height: var(--cellHYear); padding:8px 8px 6px;}
    .cell:nth-child(7n){border-right:none}
    .cell.off{opacity:.45}
    .daynum{
      position:absolute;
      top:6px;
      right:8px;
      font-size:13.5px;
      font-weight:600;
      color:#F4F6F8;
      text-shadow: 0 0 3px rgba(0,0,0,.65), 0 0 6px rgba(0,0,0,.45);
      z-index:5;
      letter-spacing:.1px;
      opacity:.92;
    }

    .items{margin-top:14px; display:flex; flex-direction:column; gap:6px}
    .year .items{margin-top:12px; gap:5px}
    .item{
      border-radius: 12px;
      padding:8px 8px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.08);
      overflow:hidden;
    }
    .year .item{padding:6px 7px; border-radius: 10px}
    .item .meta{
      display:flex; justify-content:space-between; gap:10px;
      font-size:11px; color: var(--muted2);
      margin-bottom:4px;
    }
    .year .item .meta{font-size:10px}
    .item .txt{font-size:11.2px; color: var(--text); white-space:normal; word-break:keep-all; overflow-wrap:normal; hyphens:none; line-height:1.25;}
    .year .item .txt{font-size:12px}

    .hint{font-size:11.2px; color: var(--muted); margin-top:8px;}

    /* Modal */
    .modal{
      position:fixed; inset:0; z-index:100;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .modal.open{display:flex}
    .sheet{
      width:min(860px, 100%);
      background: rgba(17,27,46,.95);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 22px;
      box-shadow: 0 30px 80px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .sheetHead{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }
    .sheetHead h3{margin:0; font-size:15px}
    .sheetBody{padding:14px 16px 16px; display:grid; gap:12px}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:12px;}
    .row.one{grid-template-columns: 1fr}
    .actions{
      display:flex; gap:10px; justify-content:space-between; flex-wrap:wrap;
      border-top:1px solid var(--stroke);
      padding:12px 16px;
      background: rgba(15,23,41,.65);
      align-items:center;
    }
    .actions .right{display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;}
    .small{font-size:11.2px; color: var(--muted2)}
    .file{display:none;}

    .existing{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height: 220px;
      overflow:auto;
    }
    .exItem{
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      padding:10px;
    }
    .exTop{
      display:flex; justify-content:space-between; gap:10px; align-items:flex-start; flex-wrap:wrap;
      font-size:11.2px; color: var(--muted);
      margin-bottom:6px;
    }
    .exTxt{white-space:normal; word-break:keep-all; overflow-wrap:normal; hyphens:none; font-size:11.2px; color: var(--text); line-height:1.25;}
    .exBtns{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .exBtns .btn{padding:7px 10px; font-size:11.2px; border-radius: 11px}

    
    /* Bottin responsive */
    @media (max-width: 840px){
      #bottinModal .sheetBody .field > div[style*="grid-template-columns"]{
        grid-template-columns: 1fr 1fr !important;
      }
    }

    @media print{
      header, .hint, .actions, .modal{display:none !important;}
      body{background:white; color:#111}
      .month{box-shadow:none; background:white; border:1px solid #ddd}
      .cell{background:white}
      .item{background:#f7f7f7; border:1px solid #e5e5e5}
      .dow{background:#f3f3f3}
      .wrap, main{max-width:none; padding:0}
      .months{grid-template-columns: 1fr 1fr; gap:10px}
      :root{--cellH: 105px; --cellHYear: 70px;}
    }

    /* Glow (plus visuel) */
    .glowCell{
      box-shadow: 0 0 0 1px rgba(255,255,255,.06) inset,
                  0 0 20px rgba(0,0,0,.18);
    }
    .glowItem{
      box-shadow: 0 0 0 1px rgba(255,255,255,.06) inset,
                  0 0 18px rgba(0,0,0,.18);
    }

  
    /* --- Mode compact (quand plusieurs mois sont affich√©s, hors focus) --- */
    .months.compact{
      --cellH: 240px;                 /* hauteur des cases en mode multi-mois */
      grid-template-columns: repeat(2, minmax(660px, 1fr));
    }
    .months.compact .cell{ padding:3px 3px 4px; gap:3px; height: var(--cellH); min-height: unset; overflow:hidden; }
    .months.compact .daynum{ top:5px; right:7px; font-size:10px; }
    .months.compact .items{ margin-top:6px; gap:4px; overflow:auto; height: calc(var(--cellH) - 12px); padding-right:2px; padding-bottom:6px; }
    .months.compact .item{ padding:4px 5px; border-radius:10px; }
    .months.compact .item .meta{ font-size:9px; margin-bottom:2px; }
    .months.compact .item .txt{
      font-size:10.5px;
      line-height:1.15;
      /* pas de coupe : on permet le scroll dans la case */
      white-space:normal; word-break:keep-all; overflow-wrap:normal; hyphens:none;
    }
    .months.compact .moreCount{
      text-align:center;
      font-weight:800;
      letter-spacing:.25px;
      color:#FFFFFF;
      font-size:11.5px;
      background: rgba(0,0,0,.25);
      border-radius:8px;
      padding:2px 0;
      z-index:4;
    }

  
    /* Scrollbar compact */
    .months.compact .items::-webkit-scrollbar{ width:8px; }
    .months.compact .items::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.16);
      border-radius: 10px;
      border: 2px solid rgba(0,0,0,0);
      background-clip: padding-box;
    }
    .months.compact .items::-webkit-scrollbar-track{ background: rgba(255,255,255,.06); border-radius: 10px; }

  
    /* --- Badge bicolore unique pour D√©cor (version tr√®s translucide) --- */
        /* --- Badge bicolore unique pour D√©cor (plus transparent pour voir la date) --- */
    .item.bicolor-decor{
      background: linear-gradient(90deg, rgba(255,23,68,.42) 0 70%, rgba(0,162,255,.42) 70% 100%) !important;
      border-color: rgba(0,162,255,.65) !important;
      box-shadow: 0 0 0 1px rgba(0,162,255,.12), 0 4px 14px rgba(0,0,0,.15);
      backdrop-filter: saturate(105%);
    }

  
    /* --- G√©n√©rale : cadre rouge renforc√© --- */
    .item.border-generale{
      border: 2.5px solid #FF1744 !important;
      box-shadow: 0 0 0 2px rgba(255,23,68,.45), 0 4px 14px rgba(0,0,0,.25);
    }

  
    /* --- Accessoires : contour jaune distinctif --- */
    .item.border-accessoires{
      border: 2px solid #FFD600 !important;
      box-shadow: 0 0 0 1px rgba(255,214,0,.35), 0 4px 14px rgba(0,0,0,.25);
    }

  
    /* --- Son : contour rouge visible --- */
    .item.border-son{
      border: 2.8px solid #FF3B30 !important;
      box-shadow: 0 0 0 2px rgba(255,59,48,.45), 0 4px 14px rgba(0,0,0,.25);
    }


    /* --- Liste d√©partement (affichage dans la page) --- */
    .deptPanel{
      max-width:1800px;
      margin: 0 auto 14px;
      padding: 14px 14px 12px;
      border-radius: var(--radius);
      border: 1px solid var(--stroke);
      background: rgba(17,27,46,.62);
      box-shadow: var(--shadow);
      display:none;
    }
    .deptPanel.open{display:block;}
    .deptHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      padding-bottom:10px;
      border-bottom:1px solid var(--stroke);
      margin-bottom:10px;
    }
    .deptHead h3{margin:0; font-size:15px;}
    .deptHead .sub{color:var(--muted2); font-size:11.5px;}
    .deptList{
      display:flex;
      flex-direction:column;
      gap:10px;
      /* IMPORTANT: pas de menu d√©roulant interne */
      max-height:none !important;
      overflow:visible !important;
    }
    .deptDay{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      padding: 10px;
    }
    .deptDayTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
      flex-wrap:wrap;
      margin-bottom:8px;
      color: var(--muted);
      font-size:11.5px;
    }
    .deptDayTop b{color:var(--text);}
    .deptItems{display:flex; flex-direction:column; gap:8px;}
    .deptItem{
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      padding: 10px;
      cursor:pointer;
    }
    .deptItem:hover{background: rgba(255,255,255,.06);}
    .deptItem .meta{
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      font-size:11.2px; color: var(--muted2);
      margin-bottom:5px;
    }
    .deptItem .txt{font-size:12px; line-height:1.25; color: var(--text);}



/* =========================
   üì± MOBILE OPTIMIZATION
   ========================= */

@media (max-width: 900px){

  .wrap{
    padding:14px 12px 16px;
  }

  /* Header plus compact */
  .top{
    flex-direction:column;
    align-items:stretch;
    gap:10px;
  }

  .panel{
    width:100%;
    padding:10px;
    gap:8px;
  }

  .field{
    min-width:unset;
    width:100%;
  }

  /* Boutons mois en grille */
  .monthButtons{
    display:grid;
    grid-template-columns: repeat(4, 1fr);
    gap:6px;
  }

  .monthButtons .btn{
    min-width:unset;
    font-size:12px;
    padding:8px 6px;
  }

  /* üî• LE PLUS IMPORTANT */
  .months{
    grid-template-columns: 1fr !important;
    padding:0 6px 20px;
  }

  .months.compact{
    grid-template-columns: 1fr !important;
  }

  .months.year{
    grid-template-columns: 1fr !important;
  }

  /* Mois pleine largeur */
  .month{
    width:100%;
  }

  /* Cases calendrier plus hautes mobile */
  :root{
    --cellH: 180px;
    --cellHYear: 90px;
  }

  /* Items plus lisibles */
  .item .txt{
    font-size:12px;
    line-height:1.25;
  }

  .daynum{
    font-size:14px;
    font-weight:700;
  }

  /* Modal plein √©cran mobile */
  .sheet{
    width:100%;
    height:100%;
    border-radius:0;
  }

  .modal{
    padding:0;
  }

  /* Bottin responsive */
  #bottinModal .sheetBody > .row.one .field > div{
    grid-template-columns: 1fr !important;
  }
}

/* üì± Tr√®s petit iPhone */
@media (max-width: 480px){

  .monthButtons{
    grid-template-columns: repeat(3, 1fr);
  }

  :root{
    --cellH: 160px;
  }

  .logo{
    width:36px;
    height:36px;
    font-size:12px;
  }

  .title h1{
    font-size:16px;
  }
}



/* =========================
   üì± MOBILE FOCUS PLUS (mois en focus)
   Objectif: voir TOUT le mois sur iPhone (scroll horizontal propre)
   ========================= */

@media (max-width: 900px){

  /* En focus: permettre le scroll horizontal du calendrier du mois */
  .month.focus{
    overflow-x:auto;
    -webkit-overflow-scrolling: touch;
  }

  /* Grille du calendrier: largeur minimale pour garder 7 colonnes lisibles */
  .month.focus .grid{
    min-width: 760px; /* ~7 colonnes + bordures */
  }

  /* En focus: en-t√™te du mois collant pendant qu'on scrolle */
  .month.focus .monthHead{
    position: sticky;
    top: 0;
    z-index: 60;
  }

  /* Jours de semaine collants aussi (juste sous l'en-t√™te) */
  .month.focus .dow{
    position: sticky;
    top: 56px; /* hauteur approximative de monthHead sur mobile */
    z-index: 50;
  }

  /* R√©duire l√©g√®rement le chrome pour gagner de l'espace */
  .monthHead .hintClick{ display:none; }
  .dow{ font-size:10px; padding:8px 6px; }

  /* Cellules un peu plus compactes en focus (mais toujours lisibles) */
  .month.focus .cell{
    padding:8px 8px 6px;
  }
  .month.focus .items{ margin-top:12px; }

  /* Indice visuel "glisser" (appara√Æt seulement en focus) */
  .month.focus::after{
    content:"‚Üî glisser pour voir tout le mois";
    position: sticky;
    left: 12px;
    bottom: 10px;
    display:inline-block;
    margin: 0 0 12px 12px;
    padding:6px 10px;
    border-radius: 999px;
    font-size: 11px;
    font-weight: 700;
    color: rgba(255,255,255,.88);
    background: rgba(0,0,0,.25);
    border: 1px solid rgba(255,255,255,.12);
    backdrop-filter: blur(8px);
    z-index: 70;
    pointer-events:none;
  }
}

/* üì± Tr√®s petit iPhone: un peu moins large */
@media (max-width: 480px){
  .month.focus .grid{ min-width: 720px; }
  .month.focus .dow{ top: 54px; }
}

</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo">TPA</div>
        <div class="title">
          <h1>Calendrier de production ‚Äî TPA</h1>
          <p>Focus par mois (clic sur l‚Äôen-t√™te) ‚Ä¢ Export/Import ‚Ä¢ Mot de passe pour modifier</p>
        </div>
      </div>

      <div class="panel">
        <div class="field">
          <label>Titre de la production</label>
          <input id="prodTitle" type="text" placeholder="Ex: Bubble Gum" />
        </div>
        <div class="field">
          <label>Producteur</label>
          <input id="producer" type="text" placeholder="Nom du producteur" />
        </div>
        <div class="field" style="min-width:120px">
          <label>Ann√©e</label>
          <input id="year" type="number" min="2000" max="2100" />
        </div>

        <div class="field" style="min-width:220px">
          <label>Acc√®s modifications</label>
          <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center">
            <div class="status lock" id="lockStatus"><span class="dot"></span><span id="lockText">Mode lecture seule</span></div>
            <button class="btn small" id="unlockBtn" type="button">D√©verrouiller</button>
            <button class="btn small ghost" id="lockBtn" type="button">Verrouiller</button>
          </div>
        </div>

        <button class="btn" id="printBtn" type="button">PDF</button>
        <button class="btn" id="exportBtn" type="button">Export JSON</button>
        <button class="btn primary" id="bottinBtn" type="button" style="background:#2962FF;border-color:#2962FF;color:white;">Bottin de production</button>
        <label class="btn" for="importFile" id="importLabel">Import JSON</label>
        <input class="file" id="importFile" type="file" accept="application/json"/>
        <button class="btn danger" id="clearBtn" type="button">Vider ann√©e</button>
      </div>
    </div>

    <div class="bar">
      <div class="monthButtons" id="monthButtons"></div>
      <div class="rightActions">
        <button class="btn small ghost" id="allMonthsBtn" type="button">Tous les mois</button>
        <button class="btn small ghost" id="noneMonthsBtn" type="button">Aucun</button>

      </div>
    </div>

    <div class="legend" id="legend"></div>

  </div>
</header>

<main>

  <section id="deptPanel" class="deptPanel" aria-live="polite">
    <div class="deptHead">
      <div>
        <h3 id="deptTitle">D√©partement</h3>
        <div class="sub" id="deptSub">Liste des dates et d√©tails</div>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
        <button class="btn small ghost" id="deptExportBtn" type="button">Exporter (CSV)</button>
        <button class="btn small" id="deptCloseBtn" type="button">Fermer</button>
      </div>
    </div>
    <div class="deptList" id="deptList"></div>
  </section>

  <div class="months" id="months"></div>
</main>

<div class="modal" id="modal">
  <div class="sheet">
    <div class="sheetHead">
      <h3 id="modalTitle">D√©tails</h3>
      <button class="btn" id="closeModal" type="button">Fermer</button>
    </div>

    <div class="sheetBody">
      <div class="row one">
        <div class="field">
          <label>√âl√©ments existants (clique ‚Äú√âditer‚Äù pour modifier un √©l√©ment)</label>
          <div class="existing" id="existingList"></div>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>D√©partement</label>
          <select id="mDept"></select>
          <div class="small" id="editHint">Lecture seule : d√©verrouille pour modifier.</div>
        </div>
        <div class="field">
          <label>Type (Remise / R√©p√©tition / Tech / R√©union / etc.)</label>
          <input id="mType" type="text" placeholder="Ex: Remise" />
        </div>
      </div>

      <div class="row one">
        <div class="field">
          <label>Texte</label>
          <textarea id="mText" rows="5" placeholder="Ex: Plan de construction pr√©liminaire..."></textarea>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>Responsable (optionnel)</label>
          <input id="mResp" type="text" placeholder="Nom / √©quipe" />
        </div>
        <div class="field">
          <label>Couleur manuelle (optionnel)</label>
          <input id="mColor" type="text" placeholder="Ex: #FFCC00 (vide = auto)" />
        </div>
      </div>

      <div class="small" id="modalInfo"></div>
    </div>

    <div class="actions">
      <div class="left">
        <button class="btn danger" id="deleteDayBtn" type="button">Effacer la journ√©e</button>
      </div>
      <div class="right">
        <button class="btn ghost" id="cancelEditBtn" type="button">Annuler √©dition</button>
        <button class="btn primary" id="saveBtn" type="button">Ajouter</button>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="bottinModal">
  <div class="sheet">
    <div class="sheetHead">
      <h3>Bottin ‚Äî √©quipe / contacts</h3>
      <button class="btn" id="closeBottin" type="button">Fermer</button>
    </div>

    <div class="sheetBody">
      <div class="small">Tout le monde peut remplir ce bottin (aucun mot de passe requis). Les infos sont sauvegard√©es automatiquement sur cet ordinateur/navigateur.</div>

      <div class="row one">
        <div class="field">
          <label>Ajouter une personne</label>
          <div style="display:grid; grid-template-columns: 1.2fr 1fr 1.2fr 1fr; gap:10px; align-items:end;">
            <div>
              <label>Nom</label>
              <input id="bName" type="text" placeholder="Nom complet" />
            </div>
            <div>
              <label>Fonction</label>
              <input id="bRole" type="text" placeholder="Fonction" />
            </div>
            <div>
              <label>Courriel</label>
              <input id="bEmail" type="text" placeholder="courriel@exemple.com" />
            </div>
            <div>
              <label>T√©l√©phone</label>
              <input id="bPhone" type="text" placeholder="506-000-0000" />
            </div>
          </div>
          <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:10px; flex-wrap:wrap;">
            <button class="btn primary" id="bAdd" type="button">Ajouter</button>
            <button class="btn danger" id="bClear" type="button">Vider bottin</button>
          </div>
        </div>
      </div>

      <div class="row one">
        <div class="field">
          <label>Liste</label>
          <div class="existing" id="bottinList"></div>
        </div>
      </div>
    </div>

    <div class="actions">
      <div class="small">Astuce : clique sur une ligne pour copier rapidement les infos.</div>
      <div class="right">
        <button class="btn" id="bottinExportBtn" type="button">Exporter bottin (CSV)</button>
      </div>
    </div>
  </div>
</div>

<script>
(async () => {
  const MONTHS_FR = ["janvier","f√©vrier","mars","avril","mai","juin","juillet","ao√ªt","septembre","octobre","novembre","d√©cembre"];
  const MONTHS_SHORT = ["Jan","F√©v","Mar","Avr","Mai","Juin","Juil","Ao√ª","Sep","Oct","Nov","D√©c"];
  const DOW_FR = ["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"];

    // Couleurs tr√®s vives (satur√©es) et distinctes
  const DEPTS = [
    {name:"Premi√®re", color:"#E53935"},
    {name:"G√©n√©rale technique", color:"#FB8C00"},
    {name:"G√©n√©rale", color:"#FB8C00"},
    {name:"D√©cor", color:"#FF1744"},               // Rouge vif
    {name:"Sc√©nographie", color:"#2ECC71"},        // Magenta
    {name:"√âclairage", color:"#FFD600"},           // Jaune n√©on
    {name:"Son", color:"#00ACC1"},                 // Cyan profond
    {name:"Vid√©o", color:"#00E676"},               // Vert fluo
    {name:"Costumes", color:"#8E24AA"},            // Violet riche
    {name:"Accessoires", color:"#26A69A"},         // Turquoise
    {name:"Marionnettes", color:"#FF3D00"},        // Orange-rouge intense
    {name:"Administration", color:"#78909C"},      // Gris bleut√©
    {name:"R√©union de prod", color:"#2962FF"},     // Bleu royal
    {name:"Technique", color:"#FF6F00"},           // Orange fort (distinct)
    {name:"Coiffure/Maquillage", color:"#FF4081"}, // Rose pop
    {name:"Couture", color:"#C6FF00"},             // Lime vif (diff√©rent du jaune)
    {name:"R√©p√©tition", color:"#00B0FF"},          // Bleu clair distinct
    {name:"Laboratoire", color:"#FF9100"},         // Orange ambr√© distinct
  ];


  const $ = (id) => document.getElementById(id);
  const keyFor = (y,m,d) => `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
  const storeKey = (year) => `TPA_CAL_${year}`;
  const metaKey  = (year) => `TPA_META_${year}`;
  const bottinKey = (year) => `TPA_BOTTIN_${year}`;
  const passKey  = () => `TPA_PASS_HASH`; // commun pour toutes les ann√©es
  const lockSessionKey = () => `TPA_UNLOCKED_SESSION`;

  function loadYear(year){
    try{ return JSON.parse(localStorage.getItem(storeKey(year)) || "{}"); }
    catch{ return {}; }
  }
  function saveYear(year, data){
    localStorage.setItem(storeKey(year), JSON.stringify(data));
  }
  function loadMeta(year){
    try{ return JSON.parse(localStorage.getItem(metaKey(year)) || "{}"); }
    catch{ return {}; }
  }
  function saveMeta(year, meta){
    localStorage.setItem(metaKey(year), JSON.stringify(meta));
  }

  function loadBottin(year){
    try{ return JSON.parse(localStorage.getItem(bottinKey(year)) || "[]"); }
    catch{ return []; }
  }
  function saveBottin(year, list){
    localStorage.setItem(bottinKey(year), JSON.stringify(list || []));
  }

  async function sha256Hex(text){
    const enc = new TextEncoder().encode(text);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    const arr = Array.from(new Uint8Array(buf));
    return arr.map(b => b.toString(16).padStart(2,'0')).join('');
  }

  let state = {
    year: new Date().getFullYear(),
    filterDept: null,
    data: {},
    selectedDateKey: null,
    selectedPretty: "",
    selectedMonths: new Set([2,4,7,8,9,10]),
    view: "months", // vue ann√©e retir√©e
    focusMonth: null,
    unlocked: false,
    editIndex: null, // index item en √©dition dans la journ√©e
    bottin: [],
  };



  // Charge automatiquement un fichier data.json (m√™me dossier que le HTML)
  // Format attendu: { year, meta, data, bottin } (comme Export JSON)
  async function autoLoadSharedData(){
    try{
      const url = "data.json?v=" + Date.now(); // anti-cache
      const res = await fetch(url, { cache: "no-store" });
      if(!res.ok) return null;
      const payload = await res.json();
      if(!payload || typeof payload !== "object" || !payload.year || !payload.data) return null;

      // √âcrit dans le stockage local pour que l'app fonctionne pareil partout
      saveYear(payload.year, payload.data);
      if(payload.meta) saveMeta(payload.year, payload.meta);
      if(payload.bottin) saveBottin(payload.year, payload.bottin);

      return payload.year;
    }catch(e){
      return null;
    }
  }

  function setUnlocked(v){
    state.unlocked = v;
    sessionStorage.setItem(lockSessionKey(), v ? "1" : "0");
    const st = $("lockStatus");
    const txt = $("lockText");
    if(v){
      st.classList.remove("lock"); st.classList.add("unlock");
      txt.textContent = "Modifications d√©verrouill√©es";
    }else{
      st.classList.remove("unlock"); st.classList.add("lock");
      txt.textContent = "Mode lecture seule";
    }
    applyLockUI();
  }

  function applyLockUI(){
    const canEdit = state.unlocked;

    // Disable buttons that modify data when locked
    $("clearBtn").disabled = !canEdit;
    $("clearBtn").classList.toggle("disabled", !canEdit);

    $("importLabel").classList.toggle("disabled", !canEdit);
    $("importLabel").style.pointerEvents = canEdit ? "auto" : "none";
    $("importLabel").style.opacity = canEdit ? "1" : ".45";

    // Modal controls
    $("saveBtn").disabled = !canEdit;
    $("saveBtn").classList.toggle("disabled", !canEdit);
    $("deleteDayBtn").disabled = !canEdit;
    $("deleteDayBtn").classList.toggle("disabled", !canEdit);
    $("cancelEditBtn").disabled = !canEdit;
    $("cancelEditBtn").classList.toggle("disabled", !canEdit);

    ["mDept","mType","mText","mResp","mColor"].forEach(id => {
      $(id).disabled = !canEdit;
    });

    $("editHint").textContent = canEdit
      ? "D√©verrouill√© : tu peux ajouter, √©diter ou supprimer."
      : "Lecture seule : clique ‚ÄúD√©verrouiller‚Äù pour modifier.";
  }

  async function ensurePasswordExists(){
    const existing = localStorage.getItem(passKey());
    if(existing) return true;

    const p1 = prompt("Cr√©er un mot de passe (il prot√©gera les modifications) :");
    if(!p1) return false;
    const p2 = prompt("Confirme le mot de passe :");
    if(p1 !== p2){ alert("Les mots de passe ne correspondent pas."); return false; }

    const h = await sha256Hex(p1);
    localStorage.setItem(passKey(), h);
    alert("Mot de passe cr√©√© ‚úÖ");
    return true;
  }

  async function unlockFlow(){
    const ok = await ensurePasswordExists();
    if(!ok) return;

    const p = prompt("Mot de passe pour d√©verrouiller :");
    if(!p) return;
    const h = await sha256Hex(p);
    const target = localStorage.getItem(passKey());
    if(h === target){
      setUnlocked(true);
      alert("D√©verrouill√© ‚úÖ");
    }else{
      alert("Mot de passe incorrect.");
    }
  }

  function lockFlow(){
    setUnlocked(false);
    alert("Verrouill√©.");
  }

  const escapeHtml = (str) => String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");

  function getDeptColor(name){
    return (DEPTS.find(d => d.name === name) || {}).color || "#6aa7ff";
  }
  function getDeptBorderColor(name){
    if(name === "D√©cor") return "#2962FF"; // bleu contour
    return getDeptColor(name);
  }

  function hexToRgba(hex, a){
    const h = (hex || "").replace("#","").trim();
    if(!/^[0-9a-fA-F]{6}$/.test(h)) return `rgba(106,167,255,${a})`;
    const r=parseInt(h.slice(0,2),16);
    const g=parseInt(h.slice(2,4),16);
    const b=parseInt(h.slice(4,6),16);
    return `rgba(${r},${g},${b},${a})`;
  }

  
  // --- Liste d√©partement (dans la page) ---
  function deptLabelForDateKey(k){
    // k = YYYY-MM-DD
    const y = parseInt(k.slice(0,4),10);
    const m = parseInt(k.slice(5,7),10)-1;
    const d = parseInt(k.slice(8,10),10);
    return {y,m,d, pretty: `${d} ${MONTHS_FR[m]} ${y}`};
  }

  function buildDeptRows(dept){
    const rows = [];
    const data = state.data || {};
    for(const k of Object.keys(data)){
      const items = (data[k] || []).filter(it => it && it.dept === dept);
      if(items.length){
        const info = deptLabelForDateKey(k);
        rows.push({k, ...info, items});
      }
    }
    rows.sort((a,b)=> a.k.localeCompare(b.k));
    return rows;
  }

  function renderDeptPanel(dept){
    const panel = $("deptPanel");
    const title = $("deptTitle");
    const sub = $("deptSub");
    const list = $("deptList");

    if(!dept){
      panel.classList.remove("open");
      panel.style.display = "none";
      list.innerHTML = "";
      return;
    }

    const color = getDeptColor(dept);
    title.textContent = `Liste ‚Äî ${dept}`;
    sub.textContent = "Clique une ligne pour ouvrir la journ√©e correspondante.";
    panel.style.display = "block";
    panel.classList.add("open");
    panel.style.borderColor = hexToRgba(color,.55);
    panel.style.boxShadow = `0 0 0 1px ${hexToRgba(color,.18)} inset, 0 18px 50px rgba(0,0,0,.35)`;

    const rows = buildDeptRows(dept);
    if(!rows.length){
      list.innerHTML = `<div class="small">Aucun √©l√©ment trouv√© pour ce d√©partement.</div>`;
      panel.scrollIntoView({behavior:"smooth", block:"start"});
      return;
    }

    list.innerHTML = "";
    rows.forEach(row => {
      const day = document.createElement("div");
      day.className = "deptDay";
      day.style.borderColor = hexToRgba(color,.35);
      day.innerHTML = `
        <div class="deptDayTop">
          <div><b>${escapeHtml(row.pretty)}</b></div>
          <div class="small">${row.items.length} √©l√©ment(s)</div>
        </div>
        <div class="deptItems"></div>
      `;
      const itemsBox = day.querySelector(".deptItems");

      row.items.forEach((it, idx) => {
        const item = document.createElement("div");
        item.className = "deptItem";
        const ccol = it.color?.trim() ? it.color.trim() : color;
        item.style.borderColor = hexToRgba(getDeptBorderColor(dept),.55);
        item.style.background = `linear-gradient(180deg, ${hexToRgba(ccol,.22)}, rgba(255,255,255,.03))`;
        item.innerHTML = `
          <div class="meta">
            <span>${escapeHtml(it.type || "√âl√©ment")}${it.resp ? " ‚Ä¢ " + escapeHtml(it.resp) : ""}</span>
            <span>${escapeHtml(dept)}</span>
          </div>
          <div class="txt">${escapeHtml(it.text || "")}</div>
        `;
        item.onclick = () => {
          // ouvrir la journ√©e + focus sur le mois
          state.focusMonth = row.m;
          render();
          // scroll au mois focus puis ouvre la modal
          setTimeout(()=> {
            document.getElementById(`m-${row.m}`)?.scrollIntoView({behavior:"smooth", block:"start"});
            openModal(row.y, row.m, row.d);
          }, 50);
        };
        itemsBox.appendChild(item);
      });

      list.appendChild(day);
    });

    panel.scrollIntoView({behavior:"smooth", block:"start"});
  }

  function closeDeptPanel(){
    state.filterDept = null;
    updateLegend();
    renderDeptPanel(null);
    state.focusMonth = null;
    render();
    window.scrollTo({top:0, behavior:"smooth"});
  }

  function exportDeptCSV(){
    const dept = state.filterDept;
    if(!dept){ alert("Choisis un d√©partement d‚Äôabord."); return; }
    const rows = buildDeptRows(dept);
    const out = [["Date","D√©partement","Type","Responsable","Texte"]];
    rows.forEach(r => {
      r.items.forEach(it => {
        out.push([r.pretty, dept, it.type||"", it.resp||"", it.text||""]);
      });
    });
    const csv = out.map(r => r.map(v => `"${String(v).replaceAll('"','""')}"`).join(",")).join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `Liste_${dept.replaceAll(" ","_")}_${state.year}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
  }

function updateLegend(){
    const pills = document.querySelectorAll(".pill");
    pills.forEach(p => {
      const dept = p.dataset.dept || null;
      if(dept === null) p.classList.toggle("active", state.filterDept === null);
      else p.classList.toggle("active", state.filterDept === dept);
    });
  }

  function updateMonthButtons(){
    document.querySelectorAll("#monthButtons .btn.toggle").forEach(btn => {
      const m = parseInt(btn.dataset.month,10);
      btn.classList.toggle("active", state.selectedMonths.has(m));
    });
  }

  function monthsToShow(){
    if(state.view === "year") return [...Array(12).keys()];
    if(state.focusMonth !== null) return [state.focusMonth];
    return Array.from(state.selectedMonths).sort((a,b)=>a-b);
  }

  function buildMonthDays(year, month){
    const first = new Date(year, month, 1);
    const last = new Date(year, month+1, 0);
    const daysInMonth = last.getDate();
    const monIndex = (first.getDay() + 6) % 7; // lundi=0
    const totalCells = Math.ceil((monIndex + daysInMonth)/7)*7;

    const cells = [];
    for(let i=0;i<totalCells;i++){
      const dayNum = i - monIndex + 1;
      if(dayNum < 1){
        const prevLast = new Date(year, month, 0).getDate();
        cells.push({y:year, m:month-1, d: prevLast + dayNum, inMonth:false});
      }else if(dayNum > daysInMonth){
        cells.push({y:year, m:month+1, d: dayNum - daysInMonth, inMonth:false});
      }else{
        cells.push({y:year, m:month, d: dayNum, inMonth:true});
      }
    }
    cells.forEach(c=>{
      let y=c.y, m=c.m;
      if(m<0){ y-=1; m=11; }
      if(m>11){ y+=1; m=0; }
      c.y=y; c.m=m;
    });
    return cells;
  }

  function render(){
    state.year = parseInt($("year").value,10) || state.year;
    state.data = loadYear(state.year);
    state.bottin = loadBottin(state.year);

    const months = monthsToShow();
    const root = $("months");
    root.classList.toggle("year", state.view === "year");
    root.innerHTML = "";

    const compact = (state.view === "months" && state.focusMonth === null && months.length > 1);
    root.classList.toggle("compact", compact);

    if(state.view === "months" && months.length === 0){
      root.innerHTML = `<div style="max-width:1800px;margin:0 auto;color:rgba(255,255,255,.75);padding:14px 6px;">
        S√©lectionne au moins un mois √† afficher.
      </div>`;
      return;
    }

    months.forEach(month => {
      const card = document.createElement("section");
      card.className = "month";
      card.id = `m-${month}`;
      if(state.view === "months" && state.focusMonth === month) card.classList.add("focus");

      const head = document.createElement("div");
      head.className = "monthHead";
      head.innerHTML = `
        <div>
          <h2>${MONTHS_FR[month]} ${state.year}</h2>
          <small>${state.filterDept ? "Filtre: " + state.filterDept : "Tous d√©partements"}</small>
        </div>
        <div class="hintClick">${state.view === "months" ? (state.focusMonth === month ? "Re-clic pour revenir" : "Clic pour focus") : ""}</div>
      `;
      head.onclick = () => {
        if(state.view !== "months") return;
        state.focusMonth = (state.focusMonth === month) ? null : month;
        render();
        if(state.focusMonth !== null){
          document.getElementById(`m-${state.focusMonth}`)?.scrollIntoView({behavior:"smooth", block:"start"});
        }
      };
      card.appendChild(head);

      const grid = document.createElement("div");
      grid.className = "grid";

      DOW_FR.forEach(d => {
        const el = document.createElement("div");
        el.className = "dow";
        el.textContent = d;
        grid.appendChild(el);
      });

      const cells = buildMonthDays(state.year, month);
      cells.forEach(c => {
        const cell = document.createElement("div");
        cell.className = "cell" + (c.inMonth ? "" : " off");

        const dayKey = keyFor(c.y, c.m, c.d);
        const items = (state.data[dayKey] || []).slice();

        const visibleItems = state.filterDept
          ? items.filter(it => it.dept === state.filterDept)
          : items;

        if((typeof compact !== 'undefined' && compact) && visibleItems.length){
          cell.title = visibleItems.map(it => `${it.dept}${it.type ? ' ‚Ä¢ ' + it.type : ''}${it.resp ? ' ‚Ä¢ ' + it.resp : ''}: ${it.text || ''}`).join('\n\n');
        }else{
          cell.title = '';
        }

        if(visibleItems.length){
          const it = visibleItems[0];
          const bg = it.color?.trim() ? it.color.trim() : getDeptColor(it.dept);
          cell.style.background = `linear-gradient(180deg, ${hexToRgba(bg,.60)}, rgba(15,23,41,.38))`;
          cell.style.borderColor = hexToRgba(getDeptBorderColor(it.dept),.72);
          cell.style.boxShadow = `0 0 0 1px ${hexToRgba(bg,.20)} inset, 0 0 24px ${hexToRgba(bg,.35)}`;
          cell.classList.add('glowCell');
        }else{
          cell.style.borderColor = "rgba(255,255,255,.08)";
          cell.style.boxShadow = "0 0 0 1px rgba(255,255,255,.04) inset";
          cell.classList.remove('glowCell');
        }

        cell.innerHTML = `<div class="daynum">${c.d}</div><div class="items"></div>`;
        const itemsBox = cell.querySelector(".items");

        const renderItems = (typeof compact !== 'undefined' && compact) ? visibleItems.slice(0,8) : visibleItems;
        renderItems.forEach(it => {
          const chip = document.createElement("div");
          chip.className = "item";
          if(it.dept === "D√©cor") chip.classList.add("bicolor-decor");
          if(it.dept === "G√©n√©rale") chip.classList.add("border-generale");
          if(it.dept === "Accessoires") chip.classList.add("border-accessoires");
          if(it.dept === "Son") chip.classList.add("border-son");
          const ccol = it.color?.trim() ? it.color.trim() : getDeptColor(it.dept);
          chip.style.borderColor = hexToRgba(getDeptBorderColor(it.dept),.78);
          chip.style.background = `linear-gradient(180deg, ${hexToRgba(ccol,.40)}, rgba(255,255,255,.05))`;
          chip.style.boxShadow = `0 0 0 1px ${hexToRgba(ccol,.22)} inset, 0 0 18px ${hexToRgba(ccol,.28)}`;
          chip.classList.add('glowItem');
          chip.title = `${it.dept}${it.type ? " ‚Ä¢ " + it.type : ""}${it.resp ? " ‚Ä¢ " + it.resp : ""}\n${it.text || ""}`;
          chip.innerHTML = `
            <div class="meta">
              <span>${escapeHtml(it.dept)}${it.type ? " ‚Ä¢ " + escapeHtml(it.type) : ""}</span>
              <span>${it.resp ? escapeHtml(it.resp) : ""}</span>
            </div>
            <div class="txt">${escapeHtml(it.text || "")}</div>
          `;
          itemsBox.appendChild(chip);
        });

        if((typeof compact !== 'undefined' && compact) && visibleItems.length > 8){
          const more = document.createElement("div");
          more.className = "item moreCount";
          const extra = visibleItems.length - 8;
          more.textContent = `+${extra}`;
          itemsBox.appendChild(more);
        }

        cell.onclick = () => openModal(c.y, c.m, c.d);
        grid.appendChild(cell);
      });

      card.appendChild(grid);
      root.appendChild(card);
    });

    
    
  }

  function hydrateMeta(){
    const year = parseInt($("year").value,10) || state.year;
    const meta = loadMeta(year);
    $("prodTitle").value = meta.title || "";
    $("producer").value = meta.producer || "";
  }
  function persistMeta(){
    if(!state.unlocked) return; // meta = modification
    const year = parseInt($("year").value,10) || state.year;
    const meta = {
      title: ($("prodTitle").value || "").trim(),
      producer: ($("producer").value || "").trim(),
      updatedAt: new Date().toISOString()
    };
    saveMeta(year, meta);
  }

  function openModal(y,m,d){
    const k = keyFor(y,m,d);
    state.selectedDateKey = k;
    state.selectedPretty = `${d} ${MONTHS_FR[m]} ${y}`;
    state.editIndex = null;

    $("modalTitle").textContent = `D√©tails ‚Äî ${state.selectedPretty}`;
    $("modalInfo").textContent = `√âl√©ments : ${(state.data[k]||[]).length}`;

    // Reset form
    $("mDept").value = DEPTS[0].name;
    $("mType").value = "";
    $("mText").value = "";
    $("mResp").value = "";
    $("mColor").value = "";
    $("saveBtn").textContent = "Ajouter";

    renderExistingList();

    $("modal").classList.add("open");
    applyLockUI();
  }

  function closeModal(){ $("modal").classList.remove("open"); }

  function renderExistingList(){
    const k = state.selectedDateKey;
    const list = $("existingList");
    list.innerHTML = "";
    const items = (state.data[k] || []);

    if(!items.length){
      list.innerHTML = `<div class="small">Aucun √©l√©ment pour cette journ√©e.</div>`;
      return;
    }

    items.forEach((it, idx) => {
      const box = document.createElement("div");
      box.className = "exItem";
      const ccol = it.color?.trim() ? it.color.trim() : getDeptColor(it.dept);
      box.style.borderColor = hexToRgba(ccol,.55);
      box.style.background = `linear-gradient(180deg, ${hexToRgba(ccol,.18)}, rgba(255,255,255,.03))`;

      box.innerHTML = `
        <div class="exTop">
          <div><b>${escapeHtml(it.dept)}</b>${it.type ? " ‚Ä¢ " + escapeHtml(it.type) : ""}${it.resp ? " ‚Ä¢ " + escapeHtml(it.resp) : ""}</div>
          <div class="exBtns">
            <button class="btn ghost" data-act="edit" data-idx="${idx}" type="button">√âditer</button>
            <button class="btn danger" data-act="del" data-idx="${idx}" type="button">Supprimer</button>
          </div>
        </div>
        <div class="exTxt">${escapeHtml(it.text || "")}</div>
      `;

      // Disable buttons when locked
      const editBtn = box.querySelector('[data-act="edit"]');
      const delBtn  = box.querySelector('[data-act="del"]');
      editBtn.disabled = !state.unlocked;
      delBtn.disabled = !state.unlocked;
      editBtn.classList.toggle("disabled", !state.unlocked);
      delBtn.classList.toggle("disabled", !state.unlocked);

      editBtn.onclick = () => startEdit(idx);
      delBtn.onclick = () => deleteItem(idx);

      list.appendChild(box);
    });
  }

  function startEdit(idx){
    if(!state.unlocked) return;
    const k = state.selectedDateKey;
    const items = (state.data[k] || []);
    const it = items[idx];
    if(!it) return;

    state.editIndex = idx;
    $("mDept").value = it.dept || DEPTS[0].name;
    $("mType").value = it.type || "";
    $("mText").value = it.text || "";
    $("mResp").value = it.resp || "";
    $("mColor").value = it.color || "";
    $("saveBtn").textContent = "Enregistrer";
    $("modalInfo").textContent = `√âdition de l‚Äô√©l√©ment #${idx+1}`;
  }

  function cancelEdit(){
    if(!state.unlocked) return;
    state.editIndex = null;
    $("mDept").value = DEPTS[0].name;
    $("mType").value = "";
    $("mText").value = "";
    $("mResp").value = "";
    $("mColor").value = "";
    $("saveBtn").textContent = "Ajouter";
    $("modalInfo").textContent = `√âl√©ments : ${(state.data[state.selectedDateKey]||[]).length}`;
  }

  function upsertItem(){
    if(!state.unlocked) return;

    const k = state.selectedDateKey;
    if(!k) return;

    const item = {
      dept: $("mDept").value,
      type: ($("mType").value || "").trim(),
      text: ($("mText").value || "").trim(),
      resp: ($("mResp").value || "").trim(),
      color: ($("mColor").value || "").trim(),
      ts: Date.now()
    };
    if(!item.text){ alert("Ajoute au moins un texte."); return; }

    const year = parseInt(k.slice(0,4),10);
    const data = loadYear(year);
    data[k] = data[k] || [];

    if(state.editIndex === null){
      data[k].push(item);
    }else{
      data[k][state.editIndex] = {...data[k][state.editIndex], ...item};
    }

    saveYear(year, data);
    state.data = data;

    cancelEdit();
    renderExistingList();
    render();
  }

  function deleteItem(idx){
    if(!state.unlocked) return;
    const k = state.selectedDateKey;
    const year = parseInt(k.slice(0,4),10);
    const data = loadYear(year);
    const items = data[k] || [];
    if(!items[idx]) return;
    if(!confirm("Supprimer cet √©l√©ment ?")) return;
    items.splice(idx, 1);
    if(items.length === 0) delete data[k];
    else data[k] = items;
    saveYear(year, data);
    state.data = data;
    cancelEdit();
    renderExistingList();
    render();
  }

  function deleteDay(){
    if(!state.unlocked) return;
    const k = state.selectedDateKey;
    if(!k) return;
    const year = parseInt(k.slice(0,4),10);
    const data = loadYear(year);
    if(!data[k] || !data[k].length){ closeModal(); return; }
    if(!confirm(`Effacer tous les √©l√©ments du ${state.selectedPretty} ?`)) return;
    delete data[k];
    saveYear(year, data);
    state.data = data;
    cancelEdit();
    renderExistingList();
    render();
  }

  function exportJSON(){
    const year = parseInt($("year").value,10);
    const data = loadYear(year);
    const meta = loadMeta(year);
    const bottin = loadBottin(year);
    const payload = { year, exportedAt: new Date().toISOString(), meta, data, bottin };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `Calendrier_TPA_${year}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function importJSON(file){
    if(!state.unlocked){ alert("D√©verrouille pour importer."); return; }
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const payload = JSON.parse(reader.result);
        if(!payload || typeof payload !== "object" || !payload.year || !payload.data){
          alert("JSON invalide."); return;
        }
        saveYear(payload.year, payload.data);
        if(payload.meta) saveMeta(payload.year, payload.meta);
        if(payload.bottin) saveBottin(payload.year, payload.bottin);

        $("year").value = payload.year;
        state.year = payload.year;
        state.focusMonth = null;
        hydrateMeta();
        render();
        alert("Import r√©ussi ‚úÖ");
      }catch{ alert("Impossible de lire ce fichier JSON."); }
    };
    reader.readAsText(file);
  }

  function clearYear(){
    if(!state.unlocked){ alert("D√©verrouille pour vider l‚Äôann√©e."); return; }
    const year = parseInt($("year").value,10);
    if(!confirm(`Vider compl√®tement l'ann√©e ${year} (toutes les donn√©es) ?`)) return;
    localStorage.removeItem(storeKey(year));
    localStorage.removeItem(metaKey(year));
    localStorage.removeItem(bottinKey(year));
    state.data = {};
    state.focusMonth = null;
    $("prodTitle").value = "";
    $("producer").value = "";
    render();
  }

  function setSelectedMonths(list){
    state.selectedMonths = new Set(list);
    if(state.focusMonth !== null && !state.selectedMonths.has(state.focusMonth)) state.focusMonth = null;
    updateMonthButtons();
    if(state.view === "months") render();
  }

  // Init UI
  function initUI(){
    $("year").value = state.year;

    // Boutons mois
    const mb = $("monthButtons");
    mb.innerHTML = "";
    MONTHS_SHORT.forEach((m, idx) => {
      const b = document.createElement("button");
      b.type = "button";
      b.className = "btn small toggle";
      b.textContent = m;
      b.dataset.month = String(idx);
      b.onclick = () => {
        if(state.selectedMonths.has(idx)) state.selectedMonths.delete(idx);
        else state.selectedMonths.add(idx);
        updateMonthButtons();
        if(state.focusMonth !== null && !state.selectedMonths.has(state.focusMonth)) state.focusMonth = null;
        if(state.view === "months") render();
      };
      mb.appendChild(b);
    });
    updateMonthButtons();

    // Dept select
    const mDept = $("mDept");
    mDept.innerHTML = "";
    DEPTS.forEach(d => {
      const o = document.createElement("option");
      o.value = d.name;
      o.textContent = d.name;
      mDept.appendChild(o);
    });

    // Legend
    const legend = $("legend");
    legend.innerHTML = "";
    const all = document.createElement("div");
    all.className = "pill active";
    all.innerHTML = `<span class="dot" style="background:rgba(255,255,255,.55)"></span> Tous`;
    all.onclick = () => { state.filterDept = null; updateLegend(); render(); renderDeptPanel(null); };
    legend.appendChild(all);

    DEPTS.forEach(d => {
      const pill = document.createElement("div");
      pill.className = "pill";
      pill.dataset.dept = d.name;
      pill.innerHTML = `<span class="dot" style="background:${d.color}"></span> ${d.name}`;
      pill.onclick = () => {
        state.filterDept = (state.filterDept === d.name) ? null : d.name;
        updateLegend();
        render();
        // Afficher la liste du d√©partement directement dans la page
        renderDeptPanel(state.filterDept);
      };
      legend.appendChild(pill);
    });

    
    // --- Dept list panel controls ---
    $("deptCloseBtn").onclick = closeDeptPanel;
    $("deptExportBtn").onclick = exportDeptCSV;

// Restore lock state per session
    const sess = sessionStorage.getItem(lockSessionKey());
    setUnlocked(sess === "1");

    // Meta load (even in locked mode you can see)
    hydrateMeta();

    // Meta changes require unlock to save
    $("prodTitle").addEventListener("input", persistMeta);
    $("producer").addEventListener("input", persistMeta);

    $("year").addEventListener("change", () => {
      state.year = parseInt($("year").value,10) || state.year;
      state.focusMonth = null;
      hydrateMeta();
      render();
    });

    $("unlockBtn").onclick = unlockFlow;
    $("lockBtn").onclick = lockFlow;

    $("printBtn").onclick = () => window.print();
    $("exportBtn").onclick = exportJSON;

    $("importFile").addEventListener("change", (e) => {
      const f = e.target.files?.[0];
      if(f) importJSON(f);
      e.target.value = "";
    });

    // --- Bottin (sans mot de passe) ---
    function renderBottin(){
      const year = parseInt($("year").value,10) || state.year;
      const list = loadBottin(year);
      state.bottin = list;

      const root = $("bottinList");
      root.innerHTML = "";
      if(!list.length){
        root.innerHTML = `<div class="small">Aucun contact pour l‚Äôinstant.</div>`;
        return;
      }

      list.forEach((p, idx) => {
        const row = document.createElement("div");
        row.className = "exItem";
        row.style.borderColor = "rgba(255,255,255,.12)";
        row.innerHTML = `
          <div class="exTop">
            <div><b>${escapeHtml(p.name||"")}</b>${p.role ? " ‚Ä¢ " + escapeHtml(p.role) : ""}</div>
            <div class="exBtns">
              <button class="btn danger" type="button" data-del="${idx}">Supprimer</button>
            </div>
          </div>
          <div class="exTxt">${p.email ? "üìß " + escapeHtml(p.email) + "\n" : ""}${p.phone ? "üìû " + escapeHtml(p.phone) : ""}</div>
        `;

        // Copy on click (easy share)
        row.onclick = (e) => {
          if(e.target && e.target.getAttribute && e.target.getAttribute("data-del") !== null) return;
          const text = `${p.name||""}\t${p.role||""}\t${p.email||""}\t${p.phone||""}`.trim();
          navigator.clipboard?.writeText(text);
        };

        const delBtn = row.querySelector("[data-del]");
        delBtn.onclick = (e) => {
          e.stopPropagation();
          if(!confirm("Supprimer ce contact ?")) return;
          const y = parseInt($("year").value,10) || state.year;
          const cur = loadBottin(y);
          cur.splice(idx, 1);
          saveBottin(y, cur);
          renderBottin();
        };

        root.appendChild(row);
      });
    }

    function openBottin(){
      renderBottin();
      $("bottinModal").classList.add("open");
    }
    function closeBottin(){
      $("bottinModal").classList.remove("open");
    }

    function addBottin(){
      const y = parseInt($("year").value,10) || state.year;
      const name  = ($("bName").value || "").trim();
      const role  = ($("bRole").value || "").trim();
      const email = ($("bEmail").value || "").trim();
      const phone = ($("bPhone").value || "").trim();
      if(!name){ alert("Ajoute au moins un nom."); return; }

      const cur = loadBottin(y);
      cur.push({name, role, email, phone, ts: Date.now()});
      // sort by name
      cur.sort((a,b)=> (a.name||"").localeCompare(b.name||"", "fr", {sensitivity:"base"}));
      saveBottin(y, cur);

      $("bName").value = "";
      $("bRole").value = "";
      $("bEmail").value = "";
      $("bPhone").value = "";
      renderBottin();
    }

    function clearBottin(){
      const y = parseInt($("year").value,10) || state.year;
      if(!confirm("Vider compl√®tement le bottin de cette ann√©e ?")) return;
      saveBottin(y, []);
      renderBottin();
    }

    function exportBottinCSV(){
      const y = parseInt($("year").value,10) || state.year;
      const list = loadBottin(y);
      const rows = [["Nom","Fonction","Courriel","T√©l√©phone"]]
        .concat(list.map(p => [p.name||"", p.role||"", p.email||"", p.phone||""]));
      const csv = rows.map(r => r.map(v => `"${String(v).replaceAll('"','""')}"`).join(",")).join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `Bottin_TPA_${y}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    $("bottinBtn").onclick = openBottin;
    $("closeBottin").onclick = closeBottin;
    $("bAdd").onclick = addBottin;
    $("bClear").onclick = clearBottin;
    $("bottinExportBtn").onclick = exportBottinCSV;

    $("bottinModal").addEventListener("click", (e)=> { if(e.target === $("bottinModal")) closeBottin(); });

    $("clearBtn").onclick = clearYear;

    $("closeModal").onclick = closeModal;
    $("modal").addEventListener("click", (e)=> { if(e.target === $("modal")) closeModal(); });

    $("saveBtn").onclick = upsertItem;
    $("deleteDayBtn").onclick = deleteDay;
    $("cancelEditBtn").onclick = cancelEdit;

    $("allMonthsBtn").onclick = () => setSelectedMonths([0,1,2,3,4,5,6,7,8,9,10,11]);
    $("noneMonthsBtn").onclick = () => setSelectedMonths([]);

  }

  const sharedYear = await autoLoadSharedData();
  if(sharedYear){ state.year = sharedYear; }
  initUI();
  updateLegend();
  render();
  applyLockUI();
})();
</script>
</body>
</html>
